# PinyinConverter 测试指南

## 概述

本指南提供了 PinyinConverter 项目完整的测试方案，包括单元测试、集成测试、性能测试、内存泄漏检测和持续集成配置。

## 快速开始

### 1. 环境准备

**系统要求：**
- PHP 7.2+ 或 8.0+
- Composer
- 足够的内存（建议 ≥ 512MB）

```bash
# 克隆项目
git clone https://github.com/tekintian/pinyin.git
cd pinyin

# 安装依赖
composer install

# 给测试脚本执行权限
chmod +x run_tests.sh
```

### 2. 运行测试

```bash
# 运行所有测试
./run_tests.sh all

# 运行快速测试（推荐用于日常开发）
./run_tests.sh fast

# 运行完整测试套件
./run_tests.sh complete

# 运行特定功能测试
./run_tests.sh basic          # 基础转换测试
./run_tests.sh polyphone      # 多音字测试
./run_tests.sh special        # 特殊字符测试
./run_tests.sh custom         # 自定义字典测试
./run_tests.sh edge           # 边界条件测试

# 运行测试套件
./run_tests.sh unit           # 单元测试套件
./run_tests.sh integration    # 集成测试套件
./run_tests.sh performance    # 性能测试套件

# 运行覆盖率测试
./run_tests.sh unit --coverage
./run_tests.sh complete --coverage

# 运行内存泄漏检测
./run_tests.sh memory
```

## 测试架构

### 新测试结构

```
tests/
├── phpunit.xml                    # PHPUnit配置文件
├── Unit/                          # 单元测试
│   ├── BasicConversionTest.php     # 基础转换功能测试
│   ├── PolyphoneTest.php          # 多音字处理测试
│   ├── SpecialCharacterTest.php    # 特殊字符处理测试
│   ├── CustomDictionaryTest.php    # 自定义字典测试
│   └── EdgeCaseTest.php          # 边界条件测试
├── Integration/                   # 集成测试
│   └── CompleteWorkflowTest.php   # 完整工作流测试
├── Performance/                   # 性能测试
│   └── PerformanceTest.php        # 性能基准测试
└── legacy/                       # 旧测试文件（已迁移）
    ├── UnitTest.php
    ├── PinyinConverterTest.php
    └── PressureTest.php
```

### 测试套件说明

#### 1. 单元测试套件 (Unit)

**BasicConversionTest.php**
- 基本汉字拼音转换
- 声调处理（有声调/无声调）
- 分隔符处理
- 多字词语转换
- 声调符号格式验证
- 高频字转换测试

**PolyphoneTest.php**
- 常见多音字转换
- 单字多音字处理
- 多音字规则管理
- 上下文相关多音字处理
- 多音字频率统计
- 复杂多音字组合

**SpecialCharacterTest.php**
- 标点符号处理
- 数字处理
- 英文字母处理
- 混合字符处理
- 特殊字符模式（keep/delete/replace）
- URL Slug生成测试

**CustomDictionaryTest.php**
- 自定义拼音添加
- 自定义拼音删除
- 自定义多字词语
- 字典持久化
- 字典优先级测试
- 批量操作测试

**EdgeCaseTest.php**
- 空值处理
- 异常输入处理
- 极限值测试
- 错误恢复
- 内存限制测试
- 并发安全性测试

#### 2. 集成测试套件 (Integration)

**CompleteWorkflowTest.php**
- 完整文章转换工作流
- 自定义字典完整工作流
- 多音字处理完整工作流
- 特殊字符处理完整工作流
- 实际应用场景模拟
- 性能监控工作流
- 错误恢复工作流

#### 3. 性能测试套件 (Performance)

**PerformanceTest.php**
- 基础转换性能测试
- 大量数据转换性能
- 内存使用效率测试
- 缓存效率测试
- 不同输入长度性能
- 并发性能模拟
- 懒加载性能测试
- 自定义字典性能测试

## 测试类型详解

### 1. 基础功能测试

#### 目的
验证各个功能模块的正确性，确保代码质量。

#### 测试文件
- `tests/legacy/UnitTest.php` - 完整的单元测试套件

#### 测试覆盖范围
- ✅ 基础拼音转换功能
- ✅ 特殊字符处理
- ✅ 多音字处理
- ✅ 自定义字典功能
- ✅ URL Slug 生成
- ✅ 批量转换
- ✅ 搜索功能
- ✅ 缓存管理
- ✅ 异常处理
- ✅ 边界场景

#### 运行方法
```bash
# 基础单元测试
./vendor/bin/phpunit tests/legacy/UnitTest.php

# 生成覆盖率报告
./vendor/bin/phpunit tests/legacy/UnitTest.php --coverage-html build/coverage

# 运行特定测试
./vendor/bin/phpunit tests/legacy/UnitTest.php --filter testBasicConversion
```

### 2. 压力测试

#### 目的
测试系统在高负载下的性能表现和稳定性。

#### 测试文件
- `tests/legacy/PressureTest.php` - 压力测试套件

#### 测试场景
1. **单线程压力测试**: 1000次迭代，测试基础性能
2. **内存泄漏检测**: 2000-10000次迭代，检测内存增长
3. **批量转换测试**: 500-2000条数据，测试批量处理能力
4. **边界场景测试**: 极端输入情况的处理能力

#### 性能指标
| 指标 | 目标值 | 说明 |
|------|--------|------|
| 转换速度 | ≥ 500次/秒 | 单线程转换性能 |
| 批量处理 | ≥ 1000条/秒 | 批量转换性能 |
| 内存增长 | < 10MB/万次 | 内存使用稳定性 |
| 响应时间 | < 2ms/次 | 单次转换响应时间 |

#### 运行方法
```bash
# 运行完整压力测试
php tests/legacy/PressureTest.php

# 单独运行内存泄漏检测
php -r '
require_once "tests/legacy/PressureTest.php";
$test = new PressureTest();
$test->memoryLeakTest(5000);
'
```

### 3. 内存泄漏检测

#### 目的
确保长时间运行不会出现内存泄漏问题。

#### 检测机制
- 每100次迭代记录内存使用
- 分析内存增长趋势
- 超过阈值时发出警告

#### 运行方法
```bash
# 基础内存检测
./run_tests.sh memory

# 扩展内存检测（10000次迭代）
php -r '
require_once "vendor/autoload.php";
use tekintian\pinyin\PinyinConverter;

$converter = new PinyinConverter();
$memory_readings = [];

for ($i = 0; $i < 10000; $i++) {
    $converter->convert("内存检测文本");
    if ($i % 500 === 0) {
        $memory_readings[] = memory_get_usage(true);
        // 检测内存增长...
    }
}
'
```

## 持续集成

### GitHub Actions 配置

项目已配置完整的 CI/CD 流水线，包含：

#### 1. 多版本测试
- PHP 7.2, 7.3, 7.4, 8.0, 8.1, 8.2, 8.3
- Ubuntu 最新环境
- 完整覆盖 composer.json 中声明的所有支持版本

#### 2. 测试流程
1. 代码检出
2. 环境设置
3. 依赖安装
4. 单元测试执行
5. 压力测试执行
6. 代码风格检查
7. 静态分析

#### 3. 专项测试
- **内存泄漏检测**: 长时间运行测试
- **性能基准测试**: 性能回归检测

### 触发条件
- 推送到 main/dev/master 分支
- 创建 Pull Request

## 测试报告

### 1. 单元测试报告

#### 覆盖率报告
```bash
# 生成 HTML 覆盖率报告
./vendor/bin/phpunit tests/legacy/UnitTest.php --coverage-html build/coverage

# 查看报告
open build/coverage/index.html
```

#### 覆盖率目标
- 行覆盖率: ≥ 90%
- 分支覆盖率: ≥ 85%
- 函数覆盖率: ≥ 95%

### 2. 压力测试报告

压力测试会自动生成详细的性能报告，包括：

```
性能汇总：
- single_thread:
  iterations: 1000
  duration: 1.234
  conversions_per_second: 810.37

内存使用分析：
- 起始内存: 12.34 MB
- 峰值内存: 15.67 MB
- 内存增长: 3.33 MB

内存泄漏检测结果：
✅ 良好：内存使用稳定，未检测到明显泄漏
```

### 3. 综合测试报告

使用测试脚本生成综合报告：
```bash
./run_tests.sh report
```

报告保存在 `build/reports/` 目录下。

## 问题排查

### 1. 常见问题

#### 测试失败
```bash
# 检查依赖
composer install

# 清理缓存
./run_tests.sh cleanup

# 重新运行
./run_tests.sh all
```

#### 内存不足
```bash
# 增加 PHP 内存限制
php -d memory_limit=1G tests/legacy/PressureTest.php

# 或修改 php.ini
memory_limit = 512M
```

#### 权限问题
```bash
# 确保脚本可执行
chmod +x run_tests.sh

# 确保目录可写
chmod -R 755 build/
```

### 2. 性能问题

#### 转换速度慢
- 检查字典文件大小
- 启用 OPcache
- 调整缓存配置

#### 内存使用过高
- 检查内存泄漏
- 优化数据结构
- 调整缓存大小

### 3. 调试技巧

#### 启用调试模式
```bash
export APP_DEBUG=true
./run_tests.sh unit
```

#### 详细输出
```bash
./vendor/bin/phpunit tests/legacy/UnitTest.php --verbose --debug
```

#### 性能分析
```bash
# 使用 Xdebug
php -d xdebug.profiler_enable=1 tests/legacy/PressureTest.php
```

## 最佳实践

### 1. 测试编写
- 遵循 AAA 模式（Arrange, Act, Assert）
- 使用有意义的测试数据
- 保持测试独立性
- 定期更新测试用例

### 2. 性能优化
- 监控关键性能指标
- 建立性能基准线
- 定期进行性能回归测试
- 优化热点代码路径

### 3. 内存管理
- 及时释放不需要的资源
- 避免循环引用
- 使用内存池技术
- 定期进行内存泄漏检测

## 贡献指南

### 1. 提交代码前
```bash
# 运行完整测试
./run_tests.sh all

# 确保所有测试通过
# 确保代码风格符合规范
# 确保没有内存泄漏
```

### 2. 添加新功能
- 编写对应的单元测试
- 添加边界场景测试
- 更新压力测试用例
- 更新文档

### 3. 性能优化
- 建立性能基准
- 进行性能测试对比
- 更新性能文档
- 添加性能监控

## 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0.0 | 2025-11-17 | 初始版本，完整测试套件 |
| 1.1.0 | 2025-11-17 | 增加内存泄漏检测 |
| 1.2.0 | 2025-11-17 | 集成 CI/CD 流水线 |
| 1.3.0 | 2025-11-17 | 增加 Unihan 数据库自动更新 |

## 相关文档

- [单元测试文档](./单元测试文档.md) - 详细的单元测试说明
- [压力测试文档](./压力测试文档.md) - 压力测试和性能监控说明
- [Unihan数据库更新文档](./Unihan数据库更新文档.md) - 自动更新机制说明
- [测试配置完成总结](./测试配置完成总结.md) - 完整的测试配置总结

## 联系方式

如有问题或建议，请通过以下方式联系：

- GitHub Issues: https://github.com/tekintian/pinyin/issues
- 邮箱: tekintian@gmail.com
- 项目主页: https://github.com/tekintian/pinyin