# æ‹¼éŸ³åå°ä»»åŠ¡è¿è¡Œå™¨ - å®Œæ•´æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

`TaskRunner` æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„åå°ä»»åŠ¡å¤„ç†ç³»ç»Ÿï¼Œä¸“é—¨ç”¨äºå¤„ç†æ‹¼éŸ³è½¬æ¢ç›¸å…³çš„åå°ä»»åŠ¡ã€‚æ”¯æŒå¤šç§è¿è¡Œæ¨¡å¼ï¼ŒåŒ…æ‹¬å®ˆæŠ¤è¿›ç¨‹ã€æ‰¹é‡å¤„ç†å’Œä¸€æ¬¡æ€§æ‰§è¡Œã€‚

## å¿«é€Ÿå¼€å§‹
```bash
# å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹
php bin/task_runner.php -m daemon -i 30

# ä¼˜é›…å…³é—­
kill -TERM $(cat /tmp/pinyin_task_daemon.pid)

# ä¼˜é›…é‡å¯
kill -HUP $(cat /tmp/pinyin_task_daemon.pid)
```

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

### å¤šæ¨¡å¼è¿è¡Œ
- **å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼**: æŒç»­è¿è¡Œï¼Œå®šæœŸæ£€æŸ¥å¹¶å¤„ç†ä»»åŠ¡
- **æ‰¹é‡å¤„ç†æ¨¡å¼**: ä¸€æ¬¡æ€§å¤„ç†æŒ‡å®šæ•°é‡çš„ä»»åŠ¡
- **ä¸€æ¬¡æ€§æ‰§è¡Œæ¨¡å¼**: å¤„ç†å½“å‰å¯ç”¨çš„ä»»åŠ¡åé€€å‡º

### ä¿¡å·å¤„ç†
- **SIGTERM/SIGINT**: ä¼˜é›…å…³é—­è¿›ç¨‹
- **SIGHUP**: ä¼˜é›…é‡å¯ï¼ˆä¿å­˜çŠ¶æ€åé‡å¯ï¼‰
- **SIGUSR1**: ä¼˜é›…é‡å¯
- **SIGUSR2**: é‡æ–°åŠ è½½é…ç½®

### è¿›ç¨‹ç®¡ç†
- åƒµå°¸è¿›ç¨‹è‡ªåŠ¨æ¸…ç†
- çŠ¶æ€æŒä¹…åŒ–å’Œè‡ªåŠ¨æ¢å¤
- è·¨å¹³å°å…¼å®¹æ€§ï¼ˆWindows/Unix/Linuxï¼‰

### ç›‘æ§ä¸ç»Ÿè®¡
- è¯¦ç»†çš„è¿è¡Œæ—¥å¿—å’Œç»Ÿè®¡ä¿¡æ¯
- å†…å­˜ä½¿ç”¨æƒ…å†µç›‘æ§
- è¿è¡Œæ—¶é—´ç»Ÿè®¡

## ğŸ“ æ–‡ä»¶ç»“æ„

```bash
.
â”œâ”€â”€ bin/
â”‚   â””â”€â”€ task_runner.php          # ä¸»ç¨‹åºæ–‡ä»¶
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ PinyinConverter.php      # æ‹¼éŸ³è½¬æ¢å™¨
â”‚   â””â”€â”€ BackgroundTaskManager.php # åå°ä»»åŠ¡ç®¡ç†å™¨
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ task_runner.md           # æœ¬æ–‡æ¡£
â””â”€â”€ vendor/                      # Composerä¾èµ–
```

## ğŸ”§ å®‰è£…ä¸éƒ¨ç½²

### ç¯å¢ƒè¦æ±‚

- **PHPç‰ˆæœ¬**: 7.4+ (æ¨è8.0+)
- **å¿…éœ€æ‰©å±•**: json
- **æ¨èæ‰©å±•**: pcntl, posix (ç”¨äºå®Œæ•´å®ˆæŠ¤è¿›ç¨‹åŠŸèƒ½)

### å®‰è£…æ­¥éª¤

#### 1. å…‹éš†é¡¹ç›®
```bash
git clone https://github.com/tekintian/pinyin.git
cd pinyin
```

#### 2. å®‰è£…ä¾èµ–
```bash
composer install
```

#### 3. å®‰è£…æ‰©å±•ï¼ˆæ¨èï¼‰
```bash
# Ubuntu/Debian
sudo apt-get install php-pcntl

# CentOS/RHEL
sudo yum install php-pcntl

# macOS (ä½¿ç”¨Homebrew)
brew install php
pecl install pcntl
```

#### 4. éªŒè¯å®‰è£…
```bash
# æ£€æŸ¥æ‰©å±•æ˜¯å¦å·²åŠ è½½
php -m | grep -E "(pcntl|posix|json)"

# è¿è¡Œæµ‹è¯•
php bin/task_runner.php -h
```

## ğŸ¯ ä½¿ç”¨æ–¹å¼

### å‘½ä»¤è¡Œé€‰é¡¹

| é€‰é¡¹ | çŸ­é€‰é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ |
|------|--------|------|--------|
| `--mode` | `-m` | æ‰§è¡Œæ¨¡å¼: batch, daemon, once | batch |
| `--batch-size` | `-b` | æ‰¹é‡å¤„ç†å¤§å° | 50 |
| `--limit` | `-l` | é™åˆ¶å¤„ç†ä»»åŠ¡æ•°é‡ | 0 (æ— é™åˆ¶) |
| `--interval` | `-i` | å®ˆæŠ¤è¿›ç¨‹æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰ | 60 |
| `--help` | `-h` | æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ | - |

### è¿è¡Œç¤ºä¾‹

#### 1. å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰
```bash
# æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡æ–°ä»»åŠ¡
php bin/task_runner.php -m daemon -i 30

# è¾“å‡ºç¤ºä¾‹
å®ˆæŠ¤è¿›ç¨‹å·²å¯åŠ¨ (PID: 12345)
[2024-01-15 10:30:00] å®ˆæŠ¤è¿›ç¨‹å¼€å§‹è¿è¡Œï¼Œæ£€æŸ¥é—´éš”: 30ç§’
[2024-01-15 10:30:30] å¤„ç†äº† 5 ä¸ªä»»åŠ¡
[2024-01-15 10:31:00] æ²¡æœ‰å¾…å¤„ç†ä»»åŠ¡
```

#### 2. æ‰¹é‡å¤„ç†æ¨¡å¼
```bash
# æ¯æ¬¡å¤„ç†100ä¸ªä»»åŠ¡ï¼Œæœ€å¤šå¤„ç†500ä¸ª
php bin/task_runner.php -m batch -b 100 -l 500

# è¾“å‡ºç¤ºä¾‹
å¼€å§‹æ‰¹é‡å¤„ç†ä»»åŠ¡...
[2024-01-15 10:30:00] å¤„ç†äº† 100 ä¸ªä»»åŠ¡
[2024-01-15 10:30:05] å¤„ç†äº† 100 ä¸ªä»»åŠ¡
è¾¾åˆ°å¤„ç†é™åˆ¶ (500)ï¼Œåœæ­¢å¤„ç†
```

#### 3. ä¸€æ¬¡æ€§æ‰§è¡Œæ¨¡å¼
```bash
# å¤„ç†å½“å‰å¯ç”¨ä»»åŠ¡åé€€å‡º
php bin/task_runner.php -m once

# è¾“å‡ºç¤ºä¾‹
æ‰§è¡Œä¸€æ¬¡æ€§ä»»åŠ¡å¤„ç†...
å¤„ç†ç»“æœï¼š
å·²å¤„ç†: 15 ä¸ªä»»åŠ¡
æˆåŠŸ: 14 ä¸ªä»»åŠ¡
å¤±è´¥: 1 ä¸ªä»»åŠ¡
```

## ğŸ”„ ä¿¡å·æ§åˆ¶

### å®ˆæŠ¤è¿›ç¨‹ä¿¡å·æ“ä½œ

```bash
# è·å–å®ˆæŠ¤è¿›ç¨‹PID
cat /tmp/pinyin_task_daemon.pid

# ä¼˜é›…å…³é—­è¿›ç¨‹
kill -TERM 12345

# ä¼˜é›…é‡å¯ï¼ˆä¿å­˜çŠ¶æ€åé‡å¯ï¼‰
kill -HUP 12345

# é‡æ–°åŠ è½½é…ç½®
kill -USR2 12345

# å¼ºåˆ¶ç»ˆæ­¢ï¼ˆä¸æ¨èï¼‰
kill -KILL 12345
```

### ä¿¡å·å¤„ç†è¯´æ˜

| ä¿¡å· | è¯´æ˜ | æ¨èä½¿ç”¨åœºæ™¯ |
|------|------|-------------|
| SIGTERM | ä¼˜é›…å…³é—­ | æ­£å¸¸å…³é—­è¿›ç¨‹ |
| SIGINT | ä¸­æ–­ä¿¡å· | Ctrl+C æˆ–è„šæœ¬ç»ˆæ­¢ |
| SIGHUP | ä¼˜é›…é‡å¯ | é…ç½®æ›´æ–°åé‡å¯ |
| SIGUSR1 | ä¼˜é›…é‡å¯ | æ‰‹åŠ¨é‡å¯ |
| SIGUSR2 | é…ç½®é‡è½½ | è¿è¡Œæ—¶é…ç½®æ›´æ–° |

## ğŸ“Š çŠ¶æ€æ–‡ä»¶ä¸ç›‘æ§

### çŠ¶æ€æ–‡ä»¶ä½ç½®

```bash
# PIDæ–‡ä»¶ï¼ˆé˜²æ­¢å¤šå®ä¾‹è¿è¡Œï¼‰
/tmp/pinyin_task_daemon.pid

# çŠ¶æ€æ–‡ä»¶ï¼ˆè‡ªåŠ¨ä¿å­˜ï¼‰
/tmp/pinyin_task_state/last_state.json
```

### çŠ¶æ€æ–‡ä»¶å†…å®¹ç¤ºä¾‹

```json
{
    "timestamp": 1705302000,
    "datetime": "2024-01-15 10:30:00",
    "stats": {
        "total": 1000,
        "pending": 50,
        "running": 0,
        "completed": 950,
        "failed": 0
    },
    "memory_usage": 16777216,
    "memory_peak": 33554432,
    "uptime": "02:30:15",
    "system_info": {
        "php_version": "8.1.12",
        "os": "Linux",
        "pid": 12345
    }
}
```

### ç›‘æ§å‘½ä»¤

```bash
# æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€
ps aux | grep pinyin_task_daemon

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
cat /proc/12345/status | grep -E "(VmRSS|VmSize)"

# æŸ¥çœ‹çŠ¶æ€æ–‡ä»¶
cat /tmp/pinyin_task_state/last_state.json | jq .
```

## ğŸ”§ é«˜çº§é…ç½®

### è‡ªå®šä¹‰é…ç½®

å¯ä»¥ä¿®æ”¹ä»¥ä¸‹å‚æ•°æ¥è‡ªå®šä¹‰è¡Œä¸ºï¼š

```php
// åœ¨ bin/task_runner.php ä¸­ä¿®æ”¹

// PIDæ–‡ä»¶è·¯å¾„
$pidFile = '/var/run/pinyin_task_daemon.pid';

// çŠ¶æ€æ–‡ä»¶ç›®å½•
$stateDir = '/var/lib/pinyin_task_state';

// å®ˆæŠ¤è¿›ç¨‹æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
$interval = 30;

// æ‰¹é‡å¤„ç†å¤§å°
$batchSize = 50;
```

### æ—¥å¿—é…ç½®

```bash
# é‡å®šå‘è¾“å‡ºåˆ°æ—¥å¿—æ–‡ä»¶
php bin/task_runner.php -m daemon -i 30 >> /var/log/pinyin_task.log 2>&1 &

# ä½¿ç”¨ç³»ç»Ÿæ—¥å¿—
php bin/task_runner.php -m daemon -i 30 | logger -t pinyin_task
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. æ‰©å±•æœªå®‰è£…
```bash
# é”™è¯¯ä¿¡æ¯
é”™è¯¯: ç¼ºå°‘å¿…éœ€æ‰©å±•: json

# è§£å†³æ–¹æ¡ˆ
sudo apt-get install php-json
```

#### 2. æƒé™é—®é¢˜
```bash
# é”™è¯¯ä¿¡æ¯
è­¦å‘Š: æ— æ³•åˆ›å»ºçŠ¶æ€ç›®å½•: /tmp/pinyin_task_state

# è§£å†³æ–¹æ¡ˆ
sudo mkdir -p /var/lib/pinyin_task_state
sudo chown www-data:www-data /var/lib/pinyin_task_state
```

#### 3. è¿›ç¨‹æ— æ³•ç»ˆæ­¢
```bash
# æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
ps aux | grep pinyin_task_daemon

# å¼ºåˆ¶ç»ˆæ­¢
kill -KILL 12345

# æ¸…ç†æ®‹ç•™æ–‡ä»¶
rm -f /tmp/pinyin_task_daemon.pid
```

### è°ƒè¯•æ¨¡å¼

```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
php bin/task_runner.php -m daemon -i 30 --verbose

# æ£€æŸ¥æ‰©å±•çŠ¶æ€
php -r "var_dump(extension_loaded('pcntl'), extension_loaded('posix'));"
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æ¨èé…ç½®

```bash
# ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
php bin/task_runner.php -m daemon -i 30 -b 100

# é«˜è´Ÿè½½ç¯å¢ƒ
php bin/task_runner.php -m daemon -i 10 -b 50

# æµ‹è¯•ç¯å¢ƒ
php bin/task_runner.php -m once -b 10
```

### ç›‘æ§æŒ‡æ ‡

- **å†…å­˜ä½¿ç”¨**: ä¿æŒåœ¨åˆç†èŒƒå›´å†…ï¼ˆé€šå¸¸ < 100MBï¼‰
- **å¤„ç†é€Ÿåº¦**: æ ¹æ®ä»»åŠ¡å¤æ‚åº¦è°ƒæ•´æ‰¹é‡å¤§å°
- **é”™è¯¯ç‡**: ç›‘æ§å¤±è´¥ä»»åŠ¡æ•°é‡
- **è¿è¡Œæ—¶é—´**: ç¡®ä¿è¿›ç¨‹ç¨³å®šè¿è¡Œ

## ğŸ”„ ç‰ˆæœ¬æ›´æ–°

### æ›´æ–°æµç¨‹

1. **å¤‡ä»½çŠ¶æ€æ–‡ä»¶**
```bash
cp /tmp/pinyin_task_state/last_state.json /tmp/pinyin_task_state/backup_$(date +%Y%m%d).json
```

2. **ä¼˜é›…åœæ­¢æ—§ç‰ˆæœ¬**
```bash
kill -TERM $(cat /tmp/pinyin_task_daemon.pid)
```

3. **æ›´æ–°ä»£ç **
```bash
git pull origin main
composer install
```

4. **å¯åŠ¨æ–°ç‰ˆæœ¬**
```bash
php bin/task_runner.php -m daemon -i 30
```

## ğŸ“ æ”¯æŒä¸è´¡çŒ®

### è·å–å¸®åŠ©

- **æ–‡æ¡£**: æŸ¥çœ‹æœ¬æ–‡æ¡£
- **é—®é¢˜**: åˆ›å»º GitHub Issue
- **è®¨è®º**: å‚ä¸é¡¹ç›®è®¨è®º

### è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. åˆ›å»º Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹ LICENSE æ–‡ä»¶ã€‚

---

**æœ€åæ›´æ–°**: 2025-11-16 
**ç‰ˆæœ¬**: 1.0.0  
**ä½œè€…**: tekintian  
**GitHub**: https://github.com/tekintian/pinyin
**è½¯ä»¶ç ”å‘**: https://dev.tekin.cn