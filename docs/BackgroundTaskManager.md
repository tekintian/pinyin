# BackgroundTaskManager åå°ä»»åŠ¡ç®¡ç†å™¨

## ğŸ“‹ æ¦‚è¿°

`BackgroundTaskManager` æ˜¯ä¸€ä¸ªæ™ºèƒ½çš„åå°ä»»åŠ¡å¤„ç†ç³»ç»Ÿï¼Œä¸“é—¨ç”¨äºå¤„ç†æ‹¼éŸ³è½¬æ¢è¿‡ç¨‹ä¸­é‡åˆ°çš„æœªè¯†åˆ«å­—ç¬¦ã€‚å®ƒèƒ½å¤Ÿè‡ªåŠ¨ä»å¤–éƒ¨æ•°æ®æºè·å–æ‹¼éŸ³ä¿¡æ¯ï¼Œå¹¶æ ¹æ®å­—ç¬¦æ€§è´¨æ™ºèƒ½åˆ†é…åˆ°åˆé€‚çš„å­—å…¸ä¸­ã€‚

## ğŸ—ï¸ æ ¸å¿ƒåŠŸèƒ½

### 1. **ä»»åŠ¡ç®¡ç†**
- åˆ›å»ºã€æ‰§è¡Œã€ç›‘æ§åå°ä»»åŠ¡
- ä¼˜å…ˆçº§è°ƒåº¦ï¼ˆ1-10çº§ï¼Œ1ä¸ºæœ€é«˜ï¼‰
- å¤±è´¥é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- å¹¶å‘æ§åˆ¶ï¼ˆé»˜è®¤æœ€å¤š3ä¸ªå¹¶å‘ä»»åŠ¡ï¼‰dui

### 2. **å­—ç¬¦è¯†åˆ«ä¸å¤„ç†**
- è‡ªåŠ¨è¯†åˆ«æœªæ‰¾åˆ°æ‹¼éŸ³çš„å­—ç¬¦
- æ™ºèƒ½å­—ç¬¦åˆ†ç±»ï¼ˆå¸¸ç”¨å­—ã€ç”Ÿåƒ»å­—ã€CJKæ‰©å±•å­—ç¬¦ç­‰ï¼‰
- å¤šå±‚çº§æ‹¼éŸ³è·å–ç­–ç•¥

### 3. **å­—å…¸ç®¡ç†**
- æ™ºèƒ½å­—å…¸åˆ†é…ç­–ç•¥
- è‡ªåŠ¨å­—å…¸æ–‡ä»¶æ›´æ–°
- å­—å…¸æ–‡ä»¶æ ¼å¼ç»´æŠ¤

## ğŸ“ æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ BackgroundTaskManager.php      # åå°ä»»åŠ¡ç®¡ç†å™¨ä¸»ç±»
â””â”€â”€ Utils/
    â””â”€â”€ AutoPinyinFetcher.php     # å¤–éƒ¨æ‹¼éŸ³è·å–å·¥å…·
```

## ğŸ”§ å®‰è£…ä¸é…ç½®

### åŸºæœ¬é…ç½®

```php
use tekintian\pinyin\BackgroundTaskManager;

$config = [
    'enable' => true,                    // æ˜¯å¦å¯ç”¨åå°ä»»åŠ¡
    'task_dir' => '/path/to/tasks/',     // ä»»åŠ¡æ–‡ä»¶å­˜å‚¨ç›®å½•
    'max_concurrent' => 3,               // æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°
    'task_types' => []                    // è‡ªå®šä¹‰ä»»åŠ¡ç±»å‹
];

$taskManager = new BackgroundTaskManager($config);
```

### é…ç½®å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `enable` | bool | `true` | æ˜¯å¦å¯ç”¨åå°ä»»åŠ¡å¤„ç† |
| `task_dir` | string | `../data/backup/tasks/` | ä»»åŠ¡æ–‡ä»¶å­˜å‚¨ç›®å½• |
| `max_concurrent` | int | `3` | æœ€å¤§å¹¶å‘ä»»åŠ¡æ•° |
| `task_types` | array | `[]` | è‡ªå®šä¹‰ä»»åŠ¡ç±»å‹é…ç½® |

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. åˆ›å»ºåå°ä»»åŠ¡

```php
// åˆ›å»ºæœªæ‰¾åˆ°å­—ç¬¦å¤„ç†ä»»åŠ¡
$success = $taskManager->createTask(
    'not_found_resolve',     // ä»»åŠ¡ç±»å‹
    ['char' => 'ä¶®'],         // ä»»åŠ¡æ•°æ®
    5                        // ä¼˜å…ˆçº§ï¼ˆ1-10ï¼‰
);

if ($success) {
    echo "ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼";
}
```

### 2. æ‰¹é‡å¤„ç†ä»»åŠ¡

```php
// æ‰¹é‡å¤„ç†å¾…å¤„ç†ä»»åŠ¡
$results = $taskManager->processBatch($pinyinConverter, 10);

print_r($results);
/* è¾“å‡ºç¤ºä¾‹ï¼š
[
    'processed' => 5,    // å·²å¤„ç†ä»»åŠ¡æ•°
    'succeeded' => 4,    // æˆåŠŸä»»åŠ¡æ•°
    'failed' => 1        // å¤±è´¥ä»»åŠ¡æ•°
]
*/
```

### 3. è·å–ä»»åŠ¡ç»Ÿè®¡

```php
$stats = $taskManager->getStats();

print_r($stats);
/* è¾“å‡ºç¤ºä¾‹ï¼š
[
    'total' => 15,       // æ€»ä»»åŠ¡æ•°
    'pending' => 3,      // å¾…å¤„ç†ä»»åŠ¡
    'running' => 2,      // æ‰§è¡Œä¸­ä»»åŠ¡
    'completed' => 8,    // å·²å®Œæˆä»»åŠ¡
    'failed' => 2        // å¤±è´¥ä»»åŠ¡
]
*/
```

## ğŸ” ä»»åŠ¡ç±»å‹è¯¦è§£

### 1. `not_found_resolve` - æœªæ‰¾åˆ°å­—ç¬¦å¤„ç†

**åŠŸèƒ½**ï¼šè‡ªåŠ¨å¤„ç†æœªæ‰¾åˆ°æ‹¼éŸ³çš„å­—ç¬¦

**ä»»åŠ¡æ•°æ®æ ¼å¼**ï¼š
```php
[
    'char' => 'ä¶®'  // éœ€è¦å¤„ç†çš„æ±‰å­—
]
```

**å¤„ç†æµç¨‹**ï¼š
1. ä» Unihan æƒå¨å­—å…¸æŸ¥æ‰¾æ‹¼éŸ³
2. å¦‚æœæ‰¾ä¸åˆ°ï¼Œè°ƒç”¨å¤–éƒ¨ API è·å–æ‹¼éŸ³
3. æ ¹æ®å­—ç¬¦æ€§è´¨åˆ†é…åˆ°åˆé€‚çš„å­—å…¸
4. ä»æœªæ‰¾åˆ°å­—ç¬¦åˆ—è¡¨ä¸­ç§»é™¤

### 2. `self_learn_merge` - è‡ªå­¦ä¹ å­—å…¸åˆå¹¶

**åŠŸèƒ½**ï¼šæ‰§è¡Œè‡ªå­¦ä¹ å­—å…¸çš„åˆå¹¶æ“ä½œ

**ä»»åŠ¡æ•°æ®æ ¼å¼**ï¼š
```php
[
    // å¯åŒ…å«åˆå¹¶å‚æ•°
]
```

## ğŸ”„ å­—ç¬¦å¤„ç†æµç¨‹

### å­—ç¬¦åˆ†ç±»ç­–ç•¥

```mermaid
graph TD
    A[è¾“å…¥å­—ç¬¦] --> B{å­—ç¬¦åˆ†ç±»}
    B -->|CJKåŸºæœ¬æ±‰å­—| C{æ˜¯å¦å¸¸ç”¨å­—}
    C -->|æ˜¯| D[å¸¸ç”¨å­—å…¸]
    C -->|å¦| E[ç”Ÿåƒ»å­—å­—å…¸]
    B -->|CJKæ‰©å±•å­—ç¬¦| F[ç”Ÿåƒ»å­—å­—å…¸]
    B -->|å…¶ä»–å­—ç¬¦| G[è‡ªå®šä¹‰å­—å…¸]
    
    D --> H[æ·»åŠ æ‹¼éŸ³]
    E --> H
    F --> H
    G --> H
```

### æ‹¼éŸ³è·å–ä¼˜å…ˆçº§

1. **ç¬¬ä¸€ä¼˜å…ˆçº§**ï¼šUnihan æƒå¨å­—å…¸ (`data/unihan/all_unihan_pinyin.php`)
2. **ç¬¬äºŒä¼˜å…ˆçº§**ï¼šå¤–éƒ¨ APIï¼ˆæ±‰å…¸ç½‘ + å­—å…¸APIï¼‰
3. **ç¬¬ä¸‰ä¼˜å…ˆçº§**ï¼šå­—ç¬¦ç»“æ„æ¨æµ‹

## ğŸ“Š å­—å…¸åˆ†é…ç­–ç•¥

| å­—ç¬¦ç±»å‹ | Unicode èŒƒå›´ | ç›®æ ‡å­—å…¸ | è¯´æ˜ |
|----------|---------------|----------|------|
| å¸¸ç”¨æ±‰å­— | U+4E00 - U+9FFF | `common_xxx.php` | åœ¨å¸¸ç”¨å­—å…¸ä¸­å­˜åœ¨çš„å­—ç¬¦ |
| ç”Ÿåƒ»æ±‰å­— | U+4E00 - U+9FFF | `rare_xxx.php` | ä¸åœ¨å¸¸ç”¨å­—å…¸ä¸­çš„å­—ç¬¦ |
| CJKæ‰©å±•A | U+3400 - U+4DBF | `rare_xxx.php` | CJKæ‰©å±•AåŒºå­—ç¬¦ |
| CJKæ‰©å±•B-G | U+20000 - U+2EBEF | `rare_xxx.php` | CJKæ‰©å±•B-GåŒºå­—ç¬¦ |
| å…¶ä»–å­—ç¬¦ | å…¶ä»–èŒƒå›´ | `custom_xxx.php` | ç”¨æˆ·è‡ªå®šä¹‰ç¬¦å·ç­‰ |

## ğŸ”Œ å¤–éƒ¨æ•°æ®æºé›†æˆ

### AutoPinyinFetcher é›†æˆ

`BackgroundTaskManager` ä¸ `AutoPinyinFetcher` ç´§å¯†é›†æˆï¼Œæ”¯æŒå¤šç§æ‹¼éŸ³è·å–æ–¹å¼ï¼š

```php
// è°ƒç”¨é¡ºåºï¼šDictAPI â†’ æ±‰å…¸ç½‘
$result = $fetcher->getPinyinFromDictAPI($char) ?? $fetcher->getPinyinFromZdic($char);
```

### æ”¯æŒçš„æ•°æ®æº

1. **æ±‰å…¸ç½‘ (zdic.net)** - ä¸»è¦æ•°æ®æº
2. **å­—å…¸API** - å¤‡ç”¨æ•°æ®æº
3. **Unihan æƒå¨å­—å…¸** - æœ¬åœ°æƒå¨æ•°æ®

## ğŸ› ï¸ é«˜çº§ç”¨æ³•

### è‡ªå®šä¹‰ä»»åŠ¡ç±»å‹

```php
// æ‰©å±•ä»»åŠ¡å¤„ç†é€»è¾‘
class CustomTaskManager extends BackgroundTaskManager
{
    protected function executeTaskByType(array $task, PinyinConverter $converter): bool
    {
        switch ($task['type']) {
            case 'custom_task':
                return $this->handleCustomTask($task['data'], $converter);
            default:
                return parent::executeTaskByType($task, $converter);
        }
    }
    
    private function handleCustomTask(array $data, PinyinConverter $converter): bool
    {
        // è‡ªå®šä¹‰ä»»åŠ¡å¤„ç†é€»è¾‘
        return true;
    }
}
```

### é”™è¯¯å¤„ç†ä¸æ—¥å¿—

```php
// å¯ç”¨è¯¦ç»†æ—¥å¿—
ini_set('error_log', '/path/to/error.log');

// ç›‘æ§ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€
$taskManager->processBatch($converter);
$stats = $taskManager->getStats();

if ($stats['failed'] > 0) {
    // å¤„ç†å¤±è´¥ä»»åŠ¡
    error_log("æœ‰ {$stats['failed']} ä¸ªä»»åŠ¡æ‰§è¡Œå¤±è´¥");
}
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### å¹¶å‘æ§åˆ¶
- é»˜è®¤æœ€å¤§å¹¶å‘æ•°ï¼š3
- å¯é…ç½®å¹¶å‘é™åˆ¶
- ä»»åŠ¡ä¼˜å…ˆçº§è°ƒåº¦

### æ–‡ä»¶æ“ä½œä¼˜åŒ–
- æ‰¹é‡æ–‡ä»¶è¯»å†™
- æ–‡ä»¶é”æœºåˆ¶
- å¼‚å¸¸æ¢å¤æœºåˆ¶

### å†…å­˜ç®¡ç†
- æŒ‰éœ€åŠ è½½å­—å…¸
- ä»»åŠ¡æ•°æ®åºåˆ—åŒ–
- è‡ªåŠ¨åƒåœ¾å›æ”¶

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**Q: ä»»åŠ¡åˆ›å»ºå¤±è´¥**
A: æ£€æŸ¥ä»»åŠ¡ç›®å½•æƒé™å’Œç£ç›˜ç©ºé—´

**Q: å¤–éƒ¨APIè°ƒç”¨å¤±è´¥**
A: æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIå¯ç”¨æ€§

**Q: å­—å…¸æ–‡ä»¶æ— æ³•æ›´æ–°**
A: æ£€æŸ¥æ–‡ä»¶æƒé™å’Œç£ç›˜ç©ºé—´

### è°ƒè¯•æ¨¡å¼

```php
// å¯ç”¨è°ƒè¯•æ¨¡å¼
$config = [
    'enable' => true,
    'debug' => true  // å¯ç”¨è¯¦ç»†æ—¥å¿—
];

$taskManager = new BackgroundTaskManager($config);
```

## ğŸ“ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | è¯´æ˜ |
|------|------|------|
| 1.0.0 | 2025-11-07 | åˆå§‹ç‰ˆæœ¬ï¼Œæ”¯æŒåŸºæœ¬ä»»åŠ¡ç®¡ç† |
| 1.1.0 | 2025-11-11 | é›†æˆ AutoPinyinFetcherï¼Œä¼˜åŒ–å­—ç¬¦åˆ†ç±» |

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [PinyinConverter æ–‡æ¡£](./PinyinConverter.md)
- [AutoPinyinFetcher æ–‡æ¡£](./AutoPinyinFetcher.md)
- [å­—å…¸ä¼˜å…ˆçº§è¯´æ˜](./å­—å…¸ä¼˜å…ˆçº§.md)

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäº MIT è®¸å¯è¯å¼€æºã€‚

---

**æœ€åæ›´æ–°**ï¼š2025å¹´11æœˆ12æ—¥17:15:58  
**ç»´æŠ¤è€…**ï¼štekintian