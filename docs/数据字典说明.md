# 拼音转换器 - 数据字典说明

## 字典系统架构

### 字典优先级顺序
从高到低依次为：
1. **custom_xxx** - 自定义字典（用户自定义映射）
2. **polyphone_xxx** - 多音字规则字典
3. **common_xxx** - 常用字典
4. **rare_xxx** - 生僻字字典
5. **unihan** - Unihan字典（默认CJK扩展A区）

### 字典文件结构

```
data/
├── custom_with_tone.php      # 自定义字典（带声调）
├── custom_no_tone.php        # 自定义字典（不带声调）
├── common_with_tone.php      # 常用字典（带声调）
├── common_no_tone.php        # 常用字典（不带声调）
├── rare_with_tone.php        # 生僻字字典（带声调）
├── rare_no_tone.php          # 生僻字字典（不带声调）
├── self_learn_with_tone.php  # 自学习字典（带声调）
├── self_learn_no_tone.php    # 自学习字典（不带声调）
├── polyphone_rules.php       # 多音字规则
├── char_frequency.php        # 字符频率统计
└── unihan/                   # Unihan处理后的字典
    ├── cjk_basic.php         # CJK基本汉字
    ├── cjk_ext_a.php         # CJK扩展A区
    ├── cjk_ext_b.php         # CJK扩展B区
    ├── cjk_ext_c.php         # CJK扩展C区
    ├── cjk_ext_d.php         # CJK扩展D区
    ├── cjk_ext_e.php         # CJK扩展E区
    ├── cjk_ext_f.php         # CJK扩展F区
    └── cjk_ext_g.php         # CJK扩展G区
```

## 各字典详细说明

### 1. 自定义字典 (custom_*.php)

**文件位置**: `data/custom_with_tone.php`, `data/custom_no_tone.php`

**用途**: 用户自定义的拼音映射，具有最高优先级

**数据结构**:
```php
return [
    '测试' => 'ce4 shi4',    // 带声调
    '𠮷' => 'ji2',           // 生僻字
    '〇' => 'ling2',         // 特殊字符
];
```

**特点**:
- 用户手动添加的映射
- 覆盖系统默认拼音
- 支持批量导入和导出

### 2. 多音字规则字典 (polyphone_rules.php)

**文件位置**: `data/polyphone_rules.php`

**用途**: 处理多音字的上下文规则

**数据结构**:
```php
return [
    '长' => [
        'rules' => [
            ['context' => '市长', 'pinyin' => 'zhang3'],
            ['context' => '长短', 'pinyin' => 'chang2']
        ]
    ]
];
```

**特点**:
- 基于上下文的多音字处理
- 支持复杂规则匹配
- 可扩展性强

### 3. 常用字典 (common_*.php)

**文件位置**: `data/common_with_tone.php`, `data/common_no_tone.php`

**用途**: 常用汉字的拼音映射

**数据规模**:
- 带声调: 约 84KB
- 不带声调: 约 79KB

**特点**:
- 覆盖常用汉字
- 经过优化和验证
- 定期更新维护

### 4. 生僻字字典 (rare_*.php)

**文件位置**: `data/rare_with_tone.php`, `data/rare_no_tone.php`

**用途**: 生僻汉字的拼音映射

**数据规模**:
- 带声调: 约 412KB
- 不带声调: 约 388KB

**特点**:
- 覆盖大量生僻字
- 从权威来源收集
- 按使用频率排序

### 5. 自学习字典 (self_learn_*.php)

**文件位置**: `data/self_learn_with_tone.php`, `data/self_learn_no_tone.php`

**用途**: 系统自动学习的新字符拼音

**数据结构**:
```php
return [
    '𠮷' => [
        'pinyin' => 'ji2',
        'frequency' => 5,
        'first_seen' => '2025-01-01',
        'last_seen' => '2025-11-16'
    ]
];
```

**特点**:
- 自动收集未识别的字符
- 支持频率统计
- 达到阈值后合并到常用字典

### 6. Unihan字典 (unihan/*.php)

**文件位置**: `data/unihan/` 目录下各区块文件

**用途**: 基于Unicode Unihan数据库的拼音数据

**各区块统计**:
| 区块 | 字符数量 | 文件大小 | 说明 |
|------|----------|----------|------|
| CJK基本汉字 | 20,924 | 494KB/540KB | 常用汉字 |
| CJK扩展A区 | 5,786 | 132KB/140KB | 扩展A区生僻字 |
| CJK扩展B区 | 14,614 | 337KB/354KB | 扩展B区生僻字 |
| CJK扩展C区 | 506 | 12KB/13KB | 扩展C区生僻字 |
| CJK扩展D区 | 222 | 2KB/2KB | 扩展D区生僻字 |
| CJK扩展E区 | 5,762 | 20KB/21KB | 扩展E区生僻字 |
| CJK扩展F区 | 7,473 | 3KB/3KB | 扩展F区生僻字 |
| CJK扩展G区 | 4,939 | 26KB/27KB | 扩展G区生僻字 |

**特点**:
- 基于权威的Unihan数据库
- 完整的Unicode字符覆盖
- 定期从Unicode官网更新

## 字典加载策略

### 懒加载配置
```php
'dict_loading' => [
    'strategy' => 'both',           // 加载策略
    'lazy_loading' => true,        // 启用懒加载
    'preload_priority' => ['custom', 'common'], // 预加载字典
    'lazy_dicts' => ['rare', 'unihan'] // 懒加载字典
]
```

### 内存优化
- **预加载字典**: custom, common（占用内存较小）
- **懒加载字典**: rare, unihan（占用内存较大）
- **按需加载**: 只在需要时加载生僻字字典

## 字典合并机制

### 自学习字典合并
当自学习字典中的字符达到一定频率阈值时，会自动合并到常用字典：

```php
// 合并条件
if ($charFrequency >= self::MERGE_THRESHOLD) {
    $this->mergeToCommonDict($char, $pinyin);
}
```

### 频率统计
字符使用频率统计保存在 `data/char_frequency.php`:
```php
return [
    '的' => 10000,    // 高频字
    '𠮷' => 5,        // 低频字
];
```

## 数据备份和恢复

### 备份目录
`data/backup/` 目录保存字典的备份和变更记录：

```
data/backup/
├── immediate_merge_log.json    # 即时合并日志
├── last_migration.txt         # 最后迁移记录
└── self_learn_sources.json   # 自学习来源记录
```

### 手动处理数据
`data/diy/` 目录用于手动处理的数据：

```
data/diy/
├── not_found_chars.php           # 未找到拼音的字符
├── pending_confirm_with_tone.php # 待确认拼音
└── pinyin_processing_guide.md    # 处理指南
```

## 数据更新流程

### 1. Unihan数据更新
```bash
# 更新Unihan数据
php unicode/extract_unihan.php
```

### 2. 字典合并
```bash
# 执行字典合并
php bin/task_runner.php -m once
```

### 3. 数据验证
```php
// 验证字典完整性
$validator = new DictValidator();
$result = $validator->validateAll();
```

## 性能优化建议

### 内存使用优化
1. **启用懒加载**减少初始内存占用
2. **定期清理**低频字符
3. **使用缓存**避免重复加载

### 加载速度优化
1. **预加载常用字典**
2. **压缩字典数据**
3. **使用OPcache**加速PHP执行

## 故障排除

### 常见问题

1. **字典文件损坏**
   ```bash
   # 恢复备份
   cp data/backup/common_with_tone.php data/common_with_tone.php
   ```

2. **内存不足**
   ```php
   // 调整配置
   'lazy_loading' => true,
   'preload_priority' => ['custom'] // 只预加载自定义字典
   ```

3. **拼音不准确**
   ```php
   // 检查字典优先级
   var_dump($converter->getDictPriority());
   ```

---

**数据版本**: 1.0.0  
**最后更新**: 2025-11-16  
**数据来源**: Unicode Unihan数据库 + 自定义收集