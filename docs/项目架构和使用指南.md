# 拼音转换器 - 项目架构和使用指南

## 项目概述

这是一个功能强大的汉字转拼音工具，支持自定义映射、特殊字符处理、自动学习功能和多音字处理。项目采用模块化设计，包含完整的字典管理、后台任务调度和Unihan数据集成。

## 项目结构

```
pinyin/
├── src/                    # 核心源代码
│   ├── PinyinConverter.php          # 主转换器类
│   ├── BackgroundTaskManager.php     # 后台任务管理器
│   ├── functions.php                 # 辅助函数
│   ├── Utils/                       # 工具类
│   │   ├── AutoPinyinFetcher.php    # 自动拼音获取
│   │   └── PinyinConstants.php      # 拼音常量
│   ├── Contracts/                   # 接口定义
│   │   └── ConverterInterface.php   # 转换器接口
│   └── Exception/                   # 异常类
│       └── PinyinException.php      # 拼音异常
├── bin/                    # 命令行工具
│   └── task_runner.php              # 统一任务运行器
├── tools/                  # 辅助工具
│   ├── pinyin_auto_fetch.php        # 自动拼音获取工具
│   ├── pinyin_manual_helper.php    # 手动拼音辅助工具
│   ├── pinyin_resolver.php         # 拼音解析工具
│   ├── quick_pinyin_test.php       # 快速测试工具
│   └── auto_pinyin_fetcher.php     # 自动拼音获取类
├── unicode/                # Unihan数据管理
│   ├── UnihanDataManager.php       # Unihan数据管理器
│   ├── UnihanDownloader.php        # 数据下载器
│   ├── UnihanExtractor.php         # 数据提取器
│   ├── UnihanComparator.php        # 数据对比器
│   ├── UnihanMerger.php            # 数据合并器
│   ├── UnihanValidator.php        # 数据验证器
│   └── Unihan/                     # Unihan原始数据
├── data/                   # 字典数据
│   ├── custom_*.php               # 自定义字典
│   ├── common_*.php               # 常用字典
│   ├── rare_*.php                # 生僻字字典
│   ├── self_learn_*.php           # 自学习字典
│   ├── polyphone_*.php            # 多音字规则
│   ├── unihan/                    # Unihan处理后的字典
│   └── diy/                       # 手动处理数据
├── docs/                   # 文档
└── tests/                  # 测试文件
```

## 核心功能模块

### 1. 拼音转换器 (PinyinConverter)

**主要功能：**
- 汉字转拼音转换
- 多音字智能处理
- 自定义拼音映射
- 自学习功能
- 字典管理

**使用示例：**
```php
use tekintian\pinyin\PinyinConverter;

// 基本使用
$converter = new PinyinConverter();
$result = $converter->convert('你好世界');

// 带配置使用
$converter = new PinyinConverter([
    'dict' => [
        'custom' => [
            'with_tone' => '/path/to/custom_dict.php'
        ]
    ]
]);
```

### 2. 后台任务管理器 (BackgroundTaskManager)

**主要功能：**
- 任务队列管理
- 批量任务处理
- 任务状态跟踪
- 错误处理和重试

**任务类型：**
- `not_found_resolve`: 处理未找到拼音的字符
- `self_learn_merge`: 自学习字典合并
- `dict_merge`: 字典合并任务

### 3. 统一任务运行器 (bin/task_runner.php)

**运行模式：**
- **守护进程模式** (`-m daemon`): 持续运行，定期检查任务
- **批量处理模式** (`-m batch`): 批量处理指定数量任务
- **一次性执行模式** (`-m once`): 处理当前任务后退出

**使用示例：**
```bash
# 守护进程模式（推荐生产环境）
php bin/task_runner.php -m daemon -i 60

# 批量处理模式
php bin/task_runner.php -m batch -b 100 -l 500

# 一次性执行模式
php bin/task_runner.php -m once
```

### 4. Unihan数据管理 (unicode/)

**核心组件：**
- **UnihanDataManager**: 统一管理Unihan数据
- **UnihanDownloader**: 智能下载和缓存管理
- **UnihanExtractor**: 从Unihan.zip提取拼音数据
- **UnihanComparator**: 对比Unihan与当前字典数据

**使用示例：**
```php
use tekintian\pinyin\unicode\UnihanDataManager;

$manager = new UnihanDataManager();

// 更新数据（智能缓存）
$updated = $manager->updateData();

// 生成对比报告
$report = $manager->generateReport();
```

## 字典系统

### 字典优先级
从高到低依次为：
1. **custom_xxx**: 自定义字典（最高优先级）
2. **polyphone_xxx**: 多音字规则字典
3. **common_xxx**: 常用字典
4. **rare_xxx**: 生僻字字典
5. **unihan**: Unihan字典（默认CJK扩展A区）

### 字典文件说明

| 字典类型 | 带声调文件 | 不带声调文件 | 说明 |
|---------|-----------|------------|------|
| 自定义 | `custom_with_tone.php` | `custom_no_tone.php` | 用户自定义拼音映射 |
| 常用 | `common_with_tone.php` | `common_no_tone.php` | 常用汉字拼音 |
| 生僻字 | `rare_with_tone.php` | `rare_no_tone.php` | 生僻汉字拼音 |
| 自学习 | `self_learn_with_tone.php` | `self_learn_no_tone.php` | 自动学习的新字符 |
| 多音字 | `polyphone_rules.php` | - | 多音字处理规则 |

## 工具集

### 1. 自动拼音获取工具
- `tools/pinyin_auto_fetch.php`: 自动获取未找到拼音的汉字
- `tools/auto_pinyin_fetcher.php`: 拼音获取类

### 2. 手动处理工具
- `tools/pinyin_manual_helper.php`: 手动拼音辅助工具
- `tools/pinyin_resolver.php`: 拼音解析工具

### 3. 测试工具
- `tools/quick_pinyin_test.php`: 快速测试工具

## 部署和使用

### Web环境部署
```php
// index.php 示例
require_once __DIR__ . '/vendor/autoload.php';

$converter = new PinyinConverter([
    'dict_loading' => [
        'lazy_loading' => false // Web环境建议禁用懒加载
    ]
]);
```

### 命令行使用
```bash
# 安装依赖
composer install

# 运行测试
php tools/quick_pinyin_test.php

# 启动后台任务
php bin/task_runner.php -m daemon
```

### 定时任务配置
```bash
# 每天凌晨2点执行字典合并
0 2 * * * /usr/bin/php /path/to/bin/task_runner.php -m once >> /var/log/pinyin_task.log 2>&1

# 每5分钟检查任务
*/5 * * * * /usr/bin/php /path/to/bin/task_runner.php -m batch -b 10 >> /var/log/pinyin_task.log 2>&1
```

## 配置说明

### 主要配置项
```php
$config = [
    'dict' => [
        // 字典文件路径配置
    ],
    'dict_loading' => [
        'strategy' => 'both',        // 字典加载策略
        'lazy_loading' => true,      // 懒加载开关
        'preload_priority' => ['custom', 'common'], // 预加载优先级
    ],
    'custom_dict_persistence' => [
        'enable' => true,           // 自定义字典持久化
        'delay_write' => true,      // 延迟写入
        'auto_save_interval' => 300  // 自动保存间隔（秒）
    ]
];
```

## 故障排除

### 常见问题
1. **字典未加载**: 检查文件路径和权限
2. **内存不足**: 启用懒加载或调整预加载策略
3. **性能问题**: 使用延迟写入和批量处理

### 调试模式
```php
// 启用调试
$converter = new PinyinConverter([
    'debug' => true
]);
```

## 扩展开发

### 添加新的字典类型
1. 在配置中添加字典路径
2. 实现相应的字典加载逻辑
3. 更新字典优先级配置

### 自定义任务类型
1. 继承BackgroundTaskManager
2. 实现任务处理逻辑
3. 配置任务参数

---

**版本**: 1.0.0  
**最后更新**: 2025-11-16  
**维护者**: tekintian