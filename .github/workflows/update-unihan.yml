name: å®šæ—¶æ›´æ–°Unihanæ•°æ®åº“

on:
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹UTCæ‰§è¡Œ (åŒ—äº¬æ—¶é—´å‘¨ä¸€16ç‚¹)
    - cron: '0 8 * * 1'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰'
        required: false
        default: false
        type: boolean

jobs:
  update-unihan:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: è®¾ç½®PHPç¯å¢ƒ
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, iconv
        
    - name: å®‰è£…Composerä¾èµ–
      run: composer install --no-progress --no-interaction
      
    - name: æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
      id: check_update
      run: |
        # æ£€æŸ¥data/unihanç›®å½•æœ€åä¿®æ”¹æ—¶é—´
        if [ -d "data/unihan" ]; then
          LAST_MOD=$(find data/unihan -type f -name "*.php" -printf "%T@\n" | sort -n | tail -1 2>/dev/null || echo "0")
          CURRENT_TIME=$(date +%s)
          AGE_DAYS=$(( (CURRENT_TIME - ${LAST_MOD%.*}) / 86400 ))
          echo "last_modification=$LAST_MOD" >> $GITHUB_OUTPUT
          echo "age_days=$AGE_DAYS" >> $GITHUB_OUTPUT
          echo "æ•°æ®å¹´é¾„: $AGE_DAYS å¤©"
        else
          echo "last_modification=0" >> $GITHUB_OUTPUT
          echo "age_days=999" >> $GITHUB_OUTPUT
          echo "data/unihanç›®å½•ä¸å­˜åœ¨"
        fi
        
    - name: æ›´æ–°Unihanæ•°æ®
      if: steps.check_update.outputs.age_days >= 7 || github.event.inputs.force_update == 'true'
      run: |
        echo "å¼€å§‹æ›´æ–°Unihanæ•°æ®åº“..."
        
        # è®¾ç½®å¼ºåˆ¶æ›´æ–°å‚æ•°
        FORCE_FLAG=""
        if [ "${{ github.event.inputs.force_update }}" = "true" ]; then
          FORCE_FLAG="--force"
          echo "å¯ç”¨å¼ºåˆ¶æ›´æ–°æ¨¡å¼"
        fi
        
        # æ›´æ–°Unihanæ•°æ®
        php unicode/extract_unihan.php --update $FORCE_FLAG
        
        # æå–æ‹¼éŸ³å­—å…¸
        php unicode/extract_unihan.php --extract
        
        echo "Unihanæ•°æ®æ›´æ–°å®Œæˆ"
        
    - name: ä¿å­˜åŸå§‹Unihan.zipæ–‡ä»¶
      if: steps.check_update.outputs.age_days >= 7 || github.event.inputs.force_update == 'true'
      run: |
        echo "ä¿å­˜åŸå§‹Unihan.zipæ–‡ä»¶..."
        mkdir -p release_artifacts
        if [ -f "unicode/Unihan.zip" ]; then
          cp unicode/Unihan.zip release_artifacts/
          echo "âœ… åŸå§‹æ–‡ä»¶å·²ä¿å­˜"
        else
          echo "âŒ æœªæ‰¾åˆ°Unihan.zipæ–‡ä»¶"
        fi
        
    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        # æ¸…ç†ä¸´æ—¶ä¸‹è½½å’Œè§£å‹æ–‡ä»¶
        echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -f unicode/Unihan.zip
        rm -rf unicode/temp_unihan
        echo "ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
        
    - name: è¿è¡Œæµ‹è¯•éªŒè¯
      if: steps.check_update.outputs.age_days >= 7 || github.event.inputs.force_update == 'true'
      run: |
        echo "è¿è¡Œæµ‹è¯•éªŒè¯æ›´æ–°ç»“æœ..."
        
        # è¿è¡Œå•å…ƒæµ‹è¯•
        if [ -f "phpunit.xml" ]; then
          ./vendor/bin/phpunit -c phpunit.xml --testsuite Unit --verbose || echo "å•å…ƒæµ‹è¯•æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ"
        fi
        
        # åŸºæœ¬åŠŸèƒ½æµ‹è¯•
        php -r "
        require_once 'vendor/autoload.php';
        try {
            \$converter = new \tekintian\pinyin\PinyinConverter();
            \$result = \$converter->convert('ä½ å¥½');
            echo 'åŸºæœ¬è½¬æ¢æµ‹è¯•: ' . (\$result ? 'âœ“ é€šè¿‡' : 'âœ— å¤±è´¥') . '\n';
            \$result = \$converter->convert('é¾˜');
            echo 'ç”Ÿåƒ»å­—æµ‹è¯•: ' . (\$result ? 'âœ“ é€šè¿‡' : 'âœ— å¤±è´¥') . '\n';
        } catch (Exception \$e) {
            echo 'æµ‹è¯•é”™è¯¯: ' . \$e->getMessage() . '\n';
            exit(1);
        }
        "
        
    - name: æäº¤æ›´æ”¹
      if: steps.check_update.outputs.age_days >= 7 || github.event.inputs.force_update == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ æ›´æ–°çš„æ•°æ®æ–‡ä»¶
        git add data/
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ–‡ä»¶éœ€è¦æäº¤"
        else
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
          git commit -m "auto: æ›´æ–°Unihanæ•°æ®åº“ ($TIMESTAMP)"
          git push
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è®¾ç½®å‘å¸ƒç‰ˆæœ¬ä¿¡æ¯
      if: steps.check_update.outputs.age_days >= 7 || github.event.inputs.force_update == 'true'
      id: set_version
      run: |
        # ä½¿ç”¨ä¸Šæµ·æ—¶åŒºç”Ÿæˆç‰ˆæœ¬å·ï¼Œæ ¼å¼ï¼šå¹´æœˆæ—¥æ—¶åˆ†
        VERSION=$(TZ='Asia/Shanghai' date +%Y%m%d%H%M)
        TIMESTAMP=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S CST')
        echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV
        echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
        echo "ç”Ÿæˆç‰ˆæœ¬å·: $VERSION"
        
    - name: æ‰“åŒ…Unihanå­—å…¸æ–‡ä»¶
      if: steps.check_update.outputs.age_days >= 7 || github.event.inputs.force_update == 'true'
      run: |
        echo "æ‰“åŒ…Unihanå­—å…¸æ–‡ä»¶..."
        mkdir -p release_artifacts/unihan_dicts
        cp data/unihan/*.php release_artifacts/unihan_dicts/
        cd release_artifacts
        zip -r unihan_dicts.zip unihan_dicts/
        echo "âœ… å­—å…¸æ–‡ä»¶æ‰“åŒ…å®Œæˆ"
        
    - name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
      if: steps.check_update.outputs.age_days >= 7 || github.event.inputs.force_update == 'true'
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: unihan-${{ env.RELEASE_VERSION }}
        release_name: Unihanæ•°æ®åº“æ›´æ–° ${{ env.RELEASE_VERSION }}
        body: |
          ## Unihanæ•°æ®åº“è‡ªåŠ¨æ›´æ–°
          - æ›´æ–°æ—¶é—´: ${{ env.TIMESTAMP }}
          - åŒ…å«æ–‡ä»¶: $(find release_artifacts -type f | wc -l) ä¸ªæ–‡ä»¶
          - å­—å…¸æ–‡ä»¶æ•°: $(find data/unihan -name '*.php' | wc -l) ä¸ª
        draft: false
        prerelease: false
        
    - name: ä¸Šä¼ Unihan.zipé™„ä»¶
      if: steps.check_update.outputs.age_days >= 7 || github.event.inputs.force_update == 'true'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release_artifacts/Unihan.zip
        asset_name: Unihan.zip
        asset_content_type: application/zip
        
    - name: ä¸Šä¼ å­—å…¸æ–‡ä»¶åŒ…é™„ä»¶
      if: steps.check_update.outputs.age_days >= 7 || github.event.inputs.force_update == 'true'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release_artifacts/unihan_dicts.zip
        asset_name: unihan_dicts.zip
        asset_content_type: application/zip
        
    - name: æ›´æ–°ç»“æœé€šçŸ¥
      if: always()
      run: |
        if [ "${{ steps.check_update.outputs.age_days }}" -ge 7 ] || [ "${{ github.event.inputs.force_update }}" = "true" ]; then
          echo "âœ… Unihanæ•°æ®åº“æ›´æ–°å®Œæˆ"
          echo "ğŸ“Š æ›´æ–°æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S CST')"
          echo "ğŸ“ ç”Ÿæˆæ–‡ä»¶: $(find data/unihan/ -name '*.php' 2>/dev/null | wc -l) ä¸ª"
          if [ "${{ steps.create_release.outputs.id }}" != "" ]; then
            echo "ğŸš€ å‘å¸ƒç‰ˆæœ¬: https://github.com/${{ github.repository }}/releases/tag/unihan-${{ env.RELEASE_VERSION }}"
          fi
        else
          echo "â„¹ï¸ æ•°æ®åº“è¾ƒæ–°ï¼Œæ— éœ€æ›´æ–°"
          echo "ğŸ“Š æ•°æ®å¹´é¾„: ${{ steps.check_update.outputs.age_days }} å¤©"
        fi