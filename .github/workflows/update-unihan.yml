name: å®šæ—¶æ›´æ–°Unihanæ•°æ®åº“

on:
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹UTCæ‰§è¡Œ (åŒ—äº¬æ—¶é—´å‘¨ä¸€16ç‚¹)
    - cron: '0 8 * * 1'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰'
        required: false
        default: false
        type: boolean

jobs:
  update-unihan:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è®¾ç½®PHPç¯å¢ƒ
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, iconv
        
    - name: å®‰è£…Composerä¾èµ–
      run: composer install --no-progress --no-interaction
      
    - name: æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
      id: check_update
      run: |
        # æ£€æŸ¥data/unihanç›®å½•æœ€åä¿®æ”¹æ—¶é—´
        if [ -d "data/unihan" ]; then
          LAST_MOD=$(find data/unihan -type f -name "*.php" -printf "%T@\n" | sort -n | tail -1 2>/dev/null || echo "0")
          CURRENT_TIME=$(date +%s)
          AGE_DAYS=$(( (CURRENT_TIME - ${LAST_MOD%.*}) / 86400 ))
          echo "last_modification=$LAST_MOD" >> $GITHUB_OUTPUT
          echo "age_days=$AGE_DAYS" >> $GITHUB_OUTPUT
          echo "æ•°æ®å¹´é¾„: $AGE_DAYS å¤©"
        else
          echo "last_modification=0" >> $GITHUB_OUTPUT
          echo "age_days=999" >> $GITHUB_OUTPUT
          echo "data/unihanç›®å½•ä¸å­˜åœ¨"
        fi
        
    - name: æ›´æ–°Unihanæ•°æ®
      if: steps.check_update.outputs.age_days >= 7 || github.event.inputs.force_update == 'true'
      run: |
        echo "å¼€å§‹æ›´æ–°Unihanæ•°æ®åº“..."
        
        # è®¾ç½®å¼ºåˆ¶æ›´æ–°å‚æ•°
        FORCE_FLAG=""
        if [ "${{ github.event.inputs.force_update }}" = "true" ]; then
          FORCE_FLAG="--force"
          echo "å¯ç”¨å¼ºåˆ¶æ›´æ–°æ¨¡å¼"
        fi
        
        # æ›´æ–°Unihanæ•°æ®
        php unicode/extract_unihan.php --update $FORCE_FLAG
        
        # æå–æ‹¼éŸ³å­—å…¸
        php unicode/extract_unihan.php --extract
        
        echo "Unihanæ•°æ®æ›´æ–°å®Œæˆ"
        
    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        # æ¸…ç†ä¸´æ—¶ä¸‹è½½å’Œè§£å‹æ–‡ä»¶
        echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -f unicode/Unihan.zip
        rm -rf unicode/temp_unihan
        echo "ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
        
    - name: è¿è¡Œæµ‹è¯•éªŒè¯
      if: steps.check_update.outputs.age_days >= 7 || github.event.inputs.force_update == 'true'
      run: |
        echo "è¿è¡Œæµ‹è¯•éªŒè¯æ›´æ–°ç»“æœ..."
        
        # è¿è¡Œå•å…ƒæµ‹è¯•
        if [ -f "phpunit.xml" ]; then
          ./vendor/bin/phpunit -c phpunit.xml --testsuite Unit --verbose || echo "å•å…ƒæµ‹è¯•æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ"
        fi
        
        # åŸºæœ¬åŠŸèƒ½æµ‹è¯•
        php -r "
        require_once 'vendor/autoload.php';
        try {
            \$converter = new \Overtrue\Pinyin\Pinyin();
            \$result = \$converter->convert('ä½ å¥½');
            echo 'åŸºæœ¬è½¬æ¢æµ‹è¯•: ' . (\$result && count(\$result) > 0 ? 'âœ“ é€šè¿‡' : 'âœ— å¤±è´¥') . \"\n\";
            \$result = \$converter->convert('é¾˜');
            echo 'ç”Ÿåƒ»å­—æµ‹è¯•: ' . (\$result && count(\$result) > 0 ? 'âœ“ é€šè¿‡' : 'âœ— å¤±è´¥') . \"\n\";
        } catch (Exception \$e) {
            echo 'æµ‹è¯•é”™è¯¯: ' . \$e->getMessage() . \"\n\";
            exit(1);
        }
        "
        
    - name: æäº¤æ›´æ”¹
      if: steps.check_update.outputs.age_days >= 7 || github.event.inputs.force_update == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ æ›´æ–°çš„æ•°æ®æ–‡ä»¶
        git add data/
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ–‡ä»¶éœ€è¦æäº¤"
        else
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
          git commit -m "auto: æ›´æ–°Unihanæ•°æ®åº“ ($TIMESTAMP)"
          git push
        fi
        
    - name: æ›´æ–°ç»“æœé€šçŸ¥
      if: always()
      run: |
        if [ "${{ steps.check_update.outputs.age_days }}" -ge 7 ] || [ "${{ github.event.inputs.force_update }}" = "true" ]; then
          echo "âœ… Unihanæ•°æ®åº“æ›´æ–°å®Œæˆ"
          echo "ğŸ“Š æ›´æ–°æ—¶é—´: $(date)"
          echo "ğŸ“ ç”Ÿæˆæ–‡ä»¶: $(find data/unihan/ -name '*.php' 2>/dev/null | wc -l) ä¸ª"
        else
          echo "â„¹ï¸ æ•°æ®åº“è¾ƒæ–°ï¼Œæ— éœ€æ›´æ–°"
          echo "ğŸ“Š æ•°æ®å¹´é¾„: ${{ steps.check_update.outputs.age_days }} å¤©"
        fi